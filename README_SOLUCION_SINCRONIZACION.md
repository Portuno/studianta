# üîÑ Soluci√≥n de Sincronizaci√≥n entre Calendarios

## Problema Identificado

Los calendarios en `SubjectView.tsx` (dentro de una materia) y `Agenda.tsx` (vista general) no estaban sincronizados porque:

1. **Tipos de eventos inconsistentes**: Usaban valores diferentes para `event_type`
2. **Falta de sincronizaci√≥n en tiempo real**: No hab√≠a mecanismo para actualizar autom√°ticamente cuando se agregaban eventos

## Soluci√≥n Implementada

### 1. Unificaci√≥n de Tipos de Eventos

**Antes (Agenda.tsx):**
```typescript
// Valores incorrectos que no coinciden con la BD
"estudio", "clase", "examen", "entrega", "otro"
```

**Despu√©s (Agenda.tsx):**
```typescript
// Valores correctos que coinciden con la BD
"exam", "practical_activity", "project_submission", "presentation", "quiz", "assignment_due", "lab_session", "other"
```

### 2. Sincronizaci√≥n en Tiempo Real

Se implement√≥ un sistema de suscripciones en tiempo real usando Supabase:

```typescript
// Suscripci√≥n a cambios en subject_events
const channel = supabase
  .channel('subject_events_changes')
  .on(
    'postgres_changes',
    {
      event: '*',
      schema: 'public',
      table: 'subject_events',
      filter: `user_id=eq.${user.id}`
    },
    (payload) => {
      // Recargar eventos autom√°ticamente
      fetchData();
      setLastUpdate(new Date());
    }
  )
  .subscribe();
```

### 3. Indicadores Visuales

- **Bot√≥n "Actualizar"**: Para actualizaci√≥n manual
- **Timestamp de √∫ltima actualizaci√≥n**: Muestra cu√°ndo se actualiz√≥ por √∫ltima vez
- **Notificaci√≥n de actualizaci√≥n en tiempo real**: Aparece cuando se recibe una actualizaci√≥n autom√°tica

## Archivos Modificados

### `src/pages/Agenda.tsx`
- ‚úÖ Unificaci√≥n de tipos de eventos
- ‚úÖ Implementaci√≥n de suscripciones en tiempo real
- ‚úÖ Funci√≥n `fetchData` reutilizable
- ‚úÖ Indicadores visuales de sincronizaci√≥n

### `src/components/SubjectView.tsx`
- ‚úÖ Ya estaba usando los tipos correctos
- ‚úÖ Los eventos se insertan correctamente en la BD

### `supabase/17_enable_realtime_subscriptions.sql`
- ‚úÖ Nuevo archivo para habilitar suscripciones en tiempo real

## Instrucciones para el Usuario

### Paso 1: Ejecutar el SQL de Supabase
```bash
# En tu panel de Supabase, ejecuta:
supabase/17_enable_realtime_subscriptions.sql
```

### Paso 2: Probar la Sincronizaci√≥n
1. Ve a **Agenda** y observa que no hay eventos
2. Ve a una **materia espec√≠fica** ‚Üí pesta√±a **Calendario**
3. **Agrega un evento** (ej: "Examen de Matem√°ticas")
4. **Regresa a Agenda** ‚Üí el evento deber√≠a aparecer autom√°ticamente

### Paso 3: Verificar Indicadores
- En Agenda, ver√°s "√öltima actualizaci√≥n: [hora]"
- Al agregar eventos, aparecer√° "‚úÖ Agenda actualizada en tiempo real"
- El bot√≥n "Actualizar" permite refrescar manualmente

## Beneficios de la Soluci√≥n

1. **Sincronizaci√≥n autom√°tica**: Los eventos aparecen en ambos lugares sin intervenci√≥n manual
2. **Consistencia de datos**: Ambos calendarios usan los mismos tipos de eventos
3. **Experiencia de usuario mejorada**: No hay confusi√≥n sobre d√≥nde est√°n los eventos
4. **Mantenimiento simplificado**: Un solo lugar para agregar eventos

## Troubleshooting

### Si los eventos no aparecen en tiempo real:
1. Verifica que ejecutaste el SQL de Supabase
2. Revisa la consola del navegador para errores
3. Usa el bot√≥n "Actualizar" manualmente
4. Verifica que el usuario est√© autenticado

### Si hay errores 400:
1. Verifica que los tipos de eventos coincidan con la BD
2. Revisa que la fecha est√© en formato YYYY-MM-DD
3. Aseg√∫rate de que todos los campos requeridos est√©n completos

## Pr√≥ximos Pasos Recomendados

1. **Implementar el mismo sistema** para `subject_schedules`
2. **Agregar notificaciones push** cuando se agreguen eventos
3. **Sincronizar con calendarios externos** (Google Calendar, etc.)
4. **Implementar cache offline** para mejor rendimiento
